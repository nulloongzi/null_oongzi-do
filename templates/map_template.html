<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ëˆ„ë£½ì§€ë„</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#fff8e1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/528/528098.png">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCnzjy0jzK6HD34Z-i7tapG3y-hkrA-XaM",
            authDomain: "nulloongzi-do.firebaseapp.com",
            projectId: "nulloongzi-do",
            storageBucket: "nulloongzi-do.firebasestorage.app",
            messagingSenderId: "1024551952678",
            appId: "1:1024551952678:web:91a0df59c12b68b968a1e7",
            measurementId: "G-L1KWREQEMW"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("ğŸ”¥ Firebase ì—°ê²° ì„±ê³µ!");
        } catch (e) { console.error("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:", e); }

        const riceData = [
            {name: "í˜„ë¯¸ë°¥", weight: 50, color: "#FFF9C4"}, 
            {name: "ë°±ë¯¸ë°¥", weight: 50, color: "#FFF59D"}, 
            {name: "í‘ë¯¸ë°¥", weight: 50, color: "#FFF176"}, 
            {name: "ë³´ë¦¬ë°¥", weight: 50, color: "#FFEE58"}, 
            {name: "ì½©ë°¥", weight: 50, color: "#FFD54F"},   
            {name: "ì˜¤ê³¡ë°¥", weight: 50, color: "#FFCA28"}, 
            {name: "ì°¨ì¡°ë°¥", weight: 10, color: "#FFE082"}, 
            {name: "ê¸°ì¥ë°¥", weight: 10, color: "#FFECB3"}, 
            {name: "ìˆ­ëŠ‰", weight: 10, color: "#FFE0B2"}, 
            {name: "ë³¶ìŒë°¥", weight: 10, color: "#FFCC80"}, 
            {name: "ë¹„ë¹”ë°¥", weight: 10, color: "#FFB74D"}, 
            {name: "ê¹€ë°¥", weight: 10, color: "#FFF8E1"},   
            {name: "ì£¼ë¨¹ë°¥", weight: 10, color: "#FFECB3"},
            {name: "ìœ ë¶€ì´ˆë°¥", weight: 10, color: "#FFE082"},
            {name: "ë®ë°¥", weight: 10, color: "#FFF59D"},
            {name: "êµ­ë°¥", weight: 10, color: "#FFCCBC"},   
            {name: "ì†¥ë°¥", weight: 10, color: "#D7CCC8"},   
            {name: "ì•½ë°¥", weight: 10, color: "#CFD8DC"},   
            {name: "ì£½", weight: 10, color: "#F5F5F5"},     
            {name: "ê³¤ë“œë ˆë°¥", weight: 10, color: "#C5E1A5"}, 
            {name: "ì˜ì–‘ë°¥", weight: 10, color: "#E6EE9C"}, 
            {name: "ì¹˜ë°¥", weight: 10, color: "#FFAB91"}, 
            {name: "í–‡ë°˜", weight: 10, color: "#FFFFFF"},
            {name: "ê³ ë´‰ë°¥", weight: 10, color: "#BCAAA4"},
            {name: "ë°¥ì•„ì €ì”¨", weight: 1, color: "#81D4FA"} 
        ];

        function generateRiceName() {
            let totalWeight = 0;
            for (let item of riceData) totalWeight += item.weight;
            let randomNum = Math.random() * totalWeight;
            let selected = riceData[0];
            for (let item of riceData) {
                if (randomNum < item.weight) { selected = item; break; }
                randomNum -= item.weight;
            }
            const chars = "abcdefghijklmnopqrstuvwxyz0123456789";
            let suffix = "";
            for (let i = 0; i < 3; i++) suffix += chars.charAt(Math.floor(Math.random() * chars.length));
            return { base: selected.name, code: suffix, full: selected.name + "-" + suffix, color: selected.color };
        }

        const allClubs = __CLUBS_JSON__;

        function findClub(id) {
            if (!id) return null;
            // 1. ë¬¸ìì—´ IDë¡œ ë³€ê²½ë˜ì—ˆìœ¼ë¯€ë¡œ íƒ€ì… ë³€í™˜ ì—†ì´ ë°”ë¡œ ë¹„êµ
            let club = allClubs.find(c => c.id === id); 
            if (club) return club;

            if (currentProfileData && currentProfileData.customTeams && currentProfileData.customTeams[id]) {
                return currentProfileData.customTeams[id];
            }
            return null;
        }

        async function checkDuplicateNickname(nickname) {
            if (!db) return false;
            const q = query(collection(db, "users"), where("full_nickname", "==", nickname));
            const querySnapshot = await getDocs(q);
            return !querySnapshot.empty; 
        }

        let currentUser = null;
        let currentProfileData = null;

        if (auth) {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    await loadOrCreateUserProfile(user);
                    updateProfileUI(true);
                } else {
                    currentUser = null;
                    currentProfileData = null;
                    updateProfileUI(false);
                }
            });
        }

        window.loginWithGoogle = async function() {
            if (!auth) return;
            const provider = new GoogleAuthProvider();
            try { await signInWithPopup(auth, provider); } catch (error) { alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message); }
        };

        window.registerWithEmail = async function() {
            const email = document.getElementById('emailInput').value;
            const pw = document.getElementById('pwInput').value;
            if(!email || !pw) { alert('ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            try { await createUserWithEmailAndPassword(auth, email, pw); } catch(e) { alert(e.message); }
        };

        window.loginWithEmail = async function() {
            const email = document.getElementById('emailInput').value;
            const pw = document.getElementById('pwInput').value;
            if(!email || !pw) { alert('ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            try { await signInWithEmailAndPassword(auth, email, pw); } catch(e) { alert(e.message); }
        };

        window.logout = function() {
            if (!auth) return;
            if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                signOut(auth).then(() => {
                    document.getElementById('profileOverlay').style.display = 'none';
                    document.getElementById('lunchboxOverlay').style.display = 'none';
                });
            }
        };

        async function loadOrCreateUserProfile(user) {
            const userRef = doc(db, "users", user.uid);
            try {
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    currentProfileData = userSnap.data();
                    if (!currentProfileData.customTeams) currentProfileData.customTeams = {};
                } else {
                    let newNameObj = null; let isUnique = false; let retryCount = 0;
                    while (!isUnique && retryCount < 10) {
                        newNameObj = generateRiceName();
                        const isDup = await checkDuplicateNickname(newNameObj.full);
                        if (!isDup) isUnique = true; else retryCount++;
                    }
                    if (!isUnique) newNameObj.full += Date.now().toString().slice(-4);
                    const now = new Date();
                    const userData = { 
                        nickname: newNameObj.base, 
                        suffix: newNameObj.code, 
                        full_nickname: newNameObj.full, 
                        color: newNameObj.color, 
                        created_at: now, 
                        email: user.email, 
                        bookmarks: [],
                        customTeams: {} 
                    };
                    await setDoc(userRef, userData);
                    currentProfileData = userData;
                    alert("í™˜ì˜í•©ë‹ˆë‹¤! [" + newNameObj.full + "]ë‹˜ì´ ë˜ì…¨ìŠµë‹ˆë‹¤! ğŸš");
                }
                renderProfileCard();
            } catch (error) { console.error("DB Error:", error); }
        }

        function updateProfileUI(isLoggedIn) {
            const loginSection = document.getElementById('loginSection');
            const profileContent = document.getElementById('profileContent');
            if (isLoggedIn) {
                if(loginSection) loginSection.style.display = 'none';
                if(profileContent) profileContent.style.display = 'block';
            } else {
                if(loginSection) loginSection.style.display = 'flex';
                if(profileContent) profileContent.style.display = 'none';
            }
        }

        function renderProfileCard() {
            if (!currentProfileData) return;
            const card = document.getElementById('myProfileCard');
            const nicknameEl = document.getElementById('pcNickname');
            const dateEl = document.getElementById('pcDate');
            const mainTeamEl = document.getElementById('pcMainTeam');
            const riceWatermark = document.getElementById('pcRiceWatermark');

            const riceName = currentProfileData.nickname || currentProfileData.full_nickname.split('-')[0];
            const foundRice = riceData.find(r => r.name === riceName);
            let bgColor = foundRice ? foundRice.color : "#fff9c4"; 
            
            card.style.backgroundColor = bgColor;
            riceWatermark.innerText = riceName;

            nicknameEl.innerText = currentProfileData.full_nickname;
            if (currentProfileData.created_at) {
                const d = new Date(currentProfileData.created_at.seconds * 1000);
                dateEl.innerText = "ê°€ì…ì¼: " + d.getFullYear() + "." + (d.getMonth()+1) + "." + d.getDate();
            }

            const bookmarks = currentProfileData.bookmarks || [];
            const validTeamIds = bookmarks.filter(id => id !== null);
            
            if (validTeamIds.length > 0) {
                const mainId = validTeamIds[0];
                const mainTeam = findClub(mainId); 
                if (mainTeam) {
                    const icon = mainTeam.isCustom ? "ğŸ™ " : "ğŸ† ";
                    mainTeamEl.innerHTML = icon + mainTeam.name;
                } else {
                    mainTeamEl.innerText = "ë°ì´í„° ì—†ìŒ";
                }
            } else {
                mainTeamEl.innerText = "ì°œí•œ íŒ€ì´ ì—†ì–´ìš”";
            }
        }

        let isEditMode = false;
        let selectedSlotIndex = null;
        let isDietPlanOpen = false;

        window.toggleEditMode = function() {
            isEditMode = !isEditMode;
            selectedSlotIndex = null;
            renderLunchboxGrid();
            const btn = document.getElementById('lbEditBtn');
            if (isEditMode) {
                btn.classList.add('editing');
                btn.innerHTML = 'âœ… ì™„ë£Œ';
            } else {
                btn.classList.remove('editing');
                btn.innerHTML = 'ğŸ½ í¸ì§‘';
                saveLunchboxToDB(); 
            }
        };

        window.toggleDietPlan = function() {
            isDietPlanOpen = !isDietPlanOpen;
            const container = document.getElementById('dietPlanContainer');
            const btn = document.getElementById('dietToggleBtn');
            if (isDietPlanOpen) {
                renderCombinedSchedule();
                container.style.height = '420px'; 
                container.classList.add('open');
                btn.innerText = 'ğŸ“… ì‹ë‹¨í‘œ ì ‘ê¸°';
            } else {
                container.style.height = '0';
                container.classList.remove('open');
                btn.innerText = 'ğŸ“… ì‹ë‹¨í‘œ (ìŠ¤ì¼€ì¤„ í™•ì¸)';
            }
        };

        window.addCustomTeam = async function() {
            if (!currentUser || !currentProfileData) { alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); return; }
            
            const name = prompt("ğŸ™ ì¶”ê°€í•  íŒ€/ì¼ì • ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”", "ê°œì¸ìš´ë™");
            if (!name || name.trim() === "") return;

            const schedule = prompt("ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì›” 19:00~21:00)", "ì›” 19:00~21:00");
            if (!schedule || schedule.trim() === "") return;

            const newId = "custom_" + Date.now(); 
            const newTeam = {
                id: newId,
                name: name,
                schedule: schedule,
                isCustom: true, 
                target: "ë‚˜ë§Œì˜ ë©”ë‰´",
                address: "ì‚¬ìš©ì ì¶”ê°€",
                lat: null, lng: null
            };

            if (!currentProfileData.customTeams) currentProfileData.customTeams = {};
            currentProfileData.customTeams[newId] = newTeam;

            await bookmarkTeam(newId);
        };

        async function saveLunchboxToDB() {
            if (!currentUser || !currentProfileData) return;
            const userRef = doc(db, "users", currentUser.uid);
            try {
                let slots = currentProfileData.tempSlots || currentProfileData.bookmarks || [null, null, null, null, null];
                while(slots.length < 5) slots.push(null);
                if(slots.length > 5) slots = slots.slice(0, 5);

                await updateDoc(userRef, { 
                    bookmarks: slots,
                    customTeams: currentProfileData.customTeams || {}
                });
                
                currentProfileData.bookmarks = slots;
                renderProfileCard(); 
                if (isDietPlanOpen) renderCombinedSchedule();
            } catch (e) { console.error("Save Error:", e); }
        }

        window.bookmarkTeam = async function(teamId) {
            if (!currentUser || !db) { alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤! ğŸš ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”."); return; }
            try {
                let slots = currentProfileData.bookmarks || [null, null, null, null, null];
                while(slots.length < 5) slots.push(null);

                if (slots.includes(teamId)) { alert("ì´ë¯¸ ë„ì‹œë½ì— ë‹´ê¸´ íŒ€ì…ë‹ˆë‹¤! ğŸ±"); return; }
                
                let emptyIndex = slots.findIndex(item => item === null);
                if (emptyIndex === -1) { alert("ë„ì‹œë½ì´ ê½‰ ì°¼ìŠµë‹ˆë‹¤! (ìµœëŒ€ 5ê°œ) ğŸ±\nê¸°ì¡´ íŒ€ì„ ë¹¼ê³  ë‹´ì•„ì£¼ì„¸ìš”."); return; }

                slots[emptyIndex] = teamId;

                const userRef = doc(db, "users", currentUser.uid);
                await updateDoc(userRef, { 
                    bookmarks: slots,
                    customTeams: currentProfileData.customTeams || {}
                });
                currentProfileData.bookmarks = slots;
                
                const team = findClub(teamId);
                const msg = team && team.isCustom ? "ë‚˜ë§Œì˜ ë©”ë‰´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ™" : "ë„ì‹œë½ì— íŒ€ì„ ë‹´ì•˜ìŠµë‹ˆë‹¤! ğŸ±";
                alert(msg);
                
                renderProfileCard(); 
                
                if(document.getElementById('lunchboxOverlay').style.display === 'flex') {
                     if(!currentProfileData.tempSlots) currentProfileData.tempSlots = [null,null,null,null,null];
                     currentProfileData.tempSlots[emptyIndex] = teamId;
                     renderLunchboxGrid();
                     if (isDietPlanOpen) renderCombinedSchedule();
                }

            } catch (e) { alert("ì°œí•˜ê¸° ì‹¤íŒ¨: " + e.message); }
        };

        window.openLunchbox = function() {
            if (!currentProfileData) { alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); return; }
            const overlay = document.getElementById('lunchboxOverlay');
            isEditMode = false;
            document.getElementById('lbEditBtn').innerHTML = 'ğŸ½ í¸ì§‘';
            document.getElementById('lbEditBtn').classList.remove('editing');
            
            isDietPlanOpen = false;
            const dietContainer = document.getElementById('dietPlanContainer');
            dietContainer.style.height = '0';
            dietContainer.classList.remove('open');
            document.getElementById('dietToggleBtn').innerText = 'ğŸ“… ì‹ë‹¨í‘œ (ìŠ¤ì¼€ì¤„ í™•ì¸)';

            let saved = currentProfileData.bookmarks || [];
            let normalized = [null, null, null, null, null];
            
            if (saved.length > 0) {
                for(let i=0; i<5; i++) {
                    if (i < saved.length) normalized[i] = saved[i];
                }
            }
            
            currentProfileData.tempSlots = normalized; 
            
            renderLunchboxGrid();
            overlay.style.display = 'flex';
        };

        function renderLunchboxGrid() {
            const grid = document.getElementById('lunchboxGrid');
            grid.innerHTML = ""; 
            const slots = currentProfileData.tempSlots || [null,null,null,null,null];
            
            const placeholders = [
                "ë°¥ì„<br>ë‹´ì•„ì£¼ì„¸ìš”ğŸš", "êµ­ì„<br>ë‹´ì•„ì£¼ì„¸ìš”ğŸ¥˜", 
                "ë°˜ì°¬1ğŸ³", "ë°˜ì°¬2ğŸ¥—", "ë°˜ì°¬3ğŸ¥¢"             
            ];

            for (let i = 0; i < 5; i++) {
                const teamId = slots[i];
                const div = document.createElement('div');
                div.className = 'lb-cell slot-' + i;
                
                if (selectedSlotIndex === i) div.classList.add('selected');

                if (teamId !== null) {
                    const team = findClub(teamId);
                    if (team) {
                        const displayName = team.isCustom ? "ğŸ™ " + team.name : team.name;
                        div.innerHTML = `<span>${displayName}</span>`;
                        div.classList.add('filled');
                        
                        if (isEditMode) {
                            const delBtn = document.createElement('div');
                            delBtn.className = 'lb-del-btn';
                            delBtn.innerText = 'âœ•';
                            // [í•µì‹¬] addEventListenerë¡œ ë³€ê²½í•˜ì—¬ ì´ë²¤íŠ¸ ì „íŒŒ í™•ì‹¤íˆ ì°¨ë‹¨
                            delBtn.addEventListener('click', function(e) {
                                e.stopPropagation(); 
                                deleteSlot(i);
                            });
                            div.appendChild(delBtn);
                            div.onclick = () => handleSlotClick(i);
                        } else {
                            div.onclick = function() { 
                                document.getElementById('lunchboxOverlay').style.display = 'none'; 
                                openClubDetail(team.id); 
                            };
                        }
                    } else {
                        // ì‚­ì œëœ íŒ€ ì²˜ë¦¬
                        div.innerHTML = `<span>ì‚­ì œëœ íŒ€</span>`;
                        div.classList.add('filled');
                        if (isEditMode) {
                             const delBtn = document.createElement('div');
                            delBtn.className = 'lb-del-btn';
                            delBtn.innerText = 'âœ•';
                            delBtn.addEventListener('click', function(e) {
                                e.stopPropagation();
                                deleteSlot(i);
                            });
                            div.appendChild(delBtn);
                        }
                    }
                } else {
                    div.innerHTML = `<span class="lb-placeholder">${placeholders[i]}</span>`;
                    div.classList.add('empty');
                    if (isEditMode) {
                        div.onclick = () => handleSlotClick(i);
                    }
                }
                grid.appendChild(div);
            }
        }

        function renderCombinedSchedule() {
            const container = document.getElementById('dietPlanBody');
            container.innerHTML = '';

            const slots = currentProfileData.tempSlots || [];
            // ëˆ„ë£½ì§€ í…Œë§ˆ íŒŒìŠ¤í…” ìƒ‰ìƒ
            const slotColors = ["#fff9c4", "#ffe0b2", "#dcedc8", "#ffccbc", "#e1bee7"]; 
            const borderColors = ["#fbc02d", "#f57c00", "#689f38", "#d84315", "#8e24aa"];

            let allEvents = [];
            let minH = 24, maxH = 0;
            let hasData = false;

            slots.forEach((teamId, idx) => {
                if(teamId !== null) {
                    const team = findClub(teamId);
                    if(team) {
                        const scheduleMap = parseScheduleText(team.schedule);
                        for (const [day, data] of Object.entries(scheduleMap)) {
                            if (data.startH < minH) minH = data.startH;
                            if (data.endH > maxH) maxH = data.endH;
                            hasData = true;
                            
                            allEvents.push({
                                teamName: team.name,
                                day: day,
                                start: data.startH + (data.startM/60),
                                end: data.endH + (data.endM/60),
                                text: data.text,
                                slotIdx: idx,
                                isCustom: team.isCustom
                            });
                        }
                    }
                }
            });

            if (!hasData) { minH = 18; maxH = 22; }
            const displayStart = Math.max(6, Math.floor(minH) - 1); 
            const displayEnd = Math.min(24, Math.ceil(maxH) + 1);
            const totalHours = displayEnd - displayStart;

            // [í•µì‹¬ ë³€ê²½] ë†’ì´ ìë™ ê³„ì‚° (ê°€ìš© ê³µê°„ 300px ê¸°ì¤€)
            const availableHeight = 300;
            const calculatedHeight = availableHeight / totalHours;
            const ROW_HEIGHT = Math.max(30, calculatedHeight); // ìµœì†Œ 30px ë³´ì¥
            
            const days = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
            const headerRow = document.createElement('div');
            headerRow.className = 'diet-header-row';
            headerRow.innerHTML = '<div class="diet-time-col header-corner"></div>';
            days.forEach(d => {
                headerRow.innerHTML += `<div class="diet-day-col header">${d}</div>`;
            });
            container.appendChild(headerRow);

            const bodyWrapper = document.createElement('div');
            bodyWrapper.className = 'diet-body-wrapper';
            // ë¶€ëª¨ ë†’ì´ì— ë§ì¶¤ (CSS flex)
            
            // ë‚´ë¶€ ì»¨í…ì¸ ì˜ ì‹¤ì œ ë†’ì´ ì„¤ì • (ìŠ¤í¬ë¡¤ ì˜ì—­)
            const totalContentHeight = totalHours * ROW_HEIGHT;

            const timeCol = document.createElement('div');
            timeCol.className = 'diet-time-col';
            timeCol.style.height = totalContentHeight + 'px'; // ë†’ì´ ì ìš©

            for(let h = displayStart; h < displayEnd; h++) {
                const label = document.createElement('div');
                label.className = 'diet-time-label';
                label.style.height = ROW_HEIGHT + 'px';
                label.innerText = getHourLabel(h);
                timeCol.appendChild(label);
            }
            bodyWrapper.appendChild(timeCol);

            days.forEach(day => {
                const dayCol = document.createElement('div');
                dayCol.className = 'diet-day-col';
                dayCol.style.height = totalContentHeight + 'px'; // ë†’ì´ ì ìš©
                
                for(let h = displayStart; h < displayEnd; h++) {
                    const line = document.createElement('div');
                    line.className = 'diet-grid-line';
                    line.style.height = ROW_HEIGHT + 'px';
                    dayCol.appendChild(line);
                }

                let dayEvents = allEvents.filter(e => e.day === day).sort((a,b) => a.start - b.start);

                dayEvents.forEach((evt, i) => {
                    let indent = 0;
                    for(let j=0; j<i; j++) {
                        const prev = dayEvents[j];
                        if (evt.start < prev.end && evt.end > prev.start) {
                            indent++; 
                        }
                    }
                    if(indent > 2) indent = 0; 

                    const topPx = (evt.start - displayStart) * ROW_HEIGHT;
                    const heightPx = (evt.end - evt.start) * ROW_HEIGHT;
                    
                    const eventDiv = document.createElement('div');
                    eventDiv.className = 'diet-event';
                    eventDiv.style.top = topPx + 'px';
                    eventDiv.style.height = Math.max(heightPx - 2, 20) + 'px'; 
                    eventDiv.style.left = (indent * 10) + '%';
                    eventDiv.style.width = (95 - (indent * 5)) + '%';
                    eventDiv.style.zIndex = indent + 1;
                    
                    eventDiv.style.backgroundColor = slotColors[evt.slotIdx];
                    eventDiv.style.borderLeft = `4px solid ${borderColors[evt.slotIdx]}`;
                    
                    const nameDisplay = evt.isCustom ? "ğŸ™" + evt.teamName : evt.teamName;
                    // ì‹œê°„ í…ìŠ¤íŠ¸ ì œê±°í•˜ê³  íŒ€ ì´ë¦„ë§Œ í‘œì‹œ
                    eventDiv.innerHTML = `<span class="evt-title">${nameDisplay}</span>`;
                    
                    dayCol.appendChild(eventDiv);
                });

                bodyWrapper.appendChild(dayCol);
            });

            container.appendChild(bodyWrapper);
        }

        window.renderCombinedSchedule = renderCombinedSchedule;

        function handleSlotClick(index) {
            if (selectedSlotIndex === null) {
                selectedSlotIndex = index;
            } else {
                if (selectedSlotIndex !== index) {
                    const temp = currentProfileData.tempSlots[selectedSlotIndex];
                    currentProfileData.tempSlots[selectedSlotIndex] = currentProfileData.tempSlots[index];
                    currentProfileData.tempSlots[index] = temp;
                }
                selectedSlotIndex = null;
            }
            renderLunchboxGrid();
            if (isDietPlanOpen) renderCombinedSchedule();
        }

        function deleteSlot(index) {
            if(confirm("ì´ ë°˜ì°¬ì„ ë„ì‹œë½ì—ì„œ ëº„ê¹Œìš”?")) {
                currentProfileData.tempSlots[index] = null;
                renderLunchboxGrid();
                if (isDietPlanOpen) renderCombinedSchedule();
            }
        }

        window.closeLunchbox = function() { 
            if(isEditMode) saveLunchboxToDB(); 
            document.getElementById('lunchboxOverlay').style.display = 'none'; 
        };

        function moveToTeamLocation(lat, lng) {
            if (window.map && window.kakao) {
                const moveLatLon = new kakao.maps.LatLng(lat, lng);
                map.setLevel(4);
                map.panTo(moveLatLon);
            }
        }

        window.editNickname = async function() {
            if (!currentUser || !db) return;
            const currentName = document.getElementById('pcNickname').innerText;
            const newName = prompt("ë³€ê²½í•  ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš” (í•˜ì´í”ˆ ê¸ˆì§€)", currentName);
            if (newName && newName.trim() !== "" && newName !== currentName) {
                if (newName.includes("-")) { alert("âš ï¸ ë‹‰ë„¤ì„ì— í•˜ì´í”ˆ(-)ì€ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\ní•˜ì´í”ˆì€ ì˜¤ì§ 'ë°¥ì•„ì €ì”¨'ê°€ ëœë¤ìœ¼ë¡œ ì§€ì–´ì¤€ ì´ë¦„ì—ë§Œ í—ˆìš©ë©ë‹ˆë‹¤!"); return; }
                try {
                    const isDup = await checkDuplicateNickname(newName);
                    if (isDup) { alert("ì´ë¯¸ ëˆ„êµ°ê°€ ì‚¬ìš© ì¤‘ì¸ ì´ë¦„ì…ë‹ˆë‹¤."); return; }
                    const userRef = doc(db, "users", currentUser.uid);
                    await updateDoc(userRef, { full_nickname: newName });
                    currentProfileData.full_nickname = newName;
                    renderProfileCard();
                    alert("ë‹‰ë„¤ì„ ë³€ê²½ ì™„ë£Œ! ğŸ¥„");
                } catch (e) { alert("ì˜¤ë¥˜: " + e); }
            }
        };

        window.toggleProfileCard = function() {
            const overlay = document.getElementById('profileOverlay');
            overlay.style.display = (overlay.style.display === 'flex') ? 'none' : 'flex';
        };
    </script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Malgun Gothic", "ë§‘ì€ ê³ ë”•", sans-serif; }
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background: #fff8e1; }
        #map { width: 100%; height: 100%; }
        
        /* [ëˆ„ë£½ì§€ í…Œë§ˆ ì»¬ëŸ¬ ë³€ìˆ˜] */
        :root { 
            --white: #fff; 
            --nurungji-yellow: #fac710; 
            --nurungji-brown: #8d6e63;
            --nurungji-dark: #5d4037;
            --nurungji-bg: #fff8e1;
            --nurungji-light: #fffde7;
            --urgent-color: #ff7043; 
            --shadow: 0 4px 10px rgba(93, 64, 55, 0.15); 
            --today-color: #d84315; 
        }
        
        .search-container { position: absolute; top: 15px; left: 15px; right: 15px; z-index: 20; display: flex; background: white; border-radius: 16px; box-shadow: var(--shadow); height: 50px; align-items: center; padding: 0 8px; border: 2px solid var(--nurungji-brown); }
        .search-icon-box { width: 40px; display: flex; justify-content: center; align-items: center; font-size: 18px; color: var(--nurungji-brown); }
        .main-search-input { flex: 1; border: none; outline: none; font-size: 15px; height: 100%; background: transparent; color: var(--nurungji-dark); }
        .separator { width: 1px; height: 20px; background: #d7ccc8; margin: 0 5px; }
        .filter-btn-icon { width: 48px; height: 100%; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 20px; color: var(--nurungji-brown); position: relative; }
        .filter-btn-icon:active { opacity: 0.5; }
        .filter-badge { position: absolute; top: 12px; right: 10px; width: 8px; height: 8px; background: var(--nurungji-yellow); border-radius: 50%; display: none; }
        .filter-badge.active { display: block; }
        
        .urgent-ticker-bar { position: absolute; top: 75px; left: 15px; right: 15px; z-index: 18; height: 44px; background: #fffbf0; border: 2px solid var(--urgent-color); border-radius: 12px; box-shadow: var(--shadow); display: none; align-items: center; padding: 0 12px; overflow: hidden; will-change: top; }
        .ticker-icon { font-size: 18px; margin-right: 10px; animation: pulse 1.5s infinite; }
        .ticker-content { flex: 1; height: 100%; position: relative; overflow: hidden; }
        .ticker-list { list-style: none; margin: 0; padding: 0; position: absolute; width: 100%; top: 0; left: 0; transition: top 0.5s ease-in-out; }
        .ticker-item { height: 44px; line-height: 44px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 14px; font-weight: 600; cursor: pointer; color: var(--nurungji-dark); }
        .ticker-item b { color: #d84315; margin-right: 5px; }

        .fab-group { position: absolute; bottom: 30px; right: 15px; z-index: 20; display: flex; flex-direction: column; gap: 12px; }
        .fab-btn { width: 50px; height: 50px; background: white; border-radius: 20px; box-shadow: var(--shadow); display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 20px; text-decoration: none; color: var(--nurungji-brown); transition: transform 0.2s; border: 2px solid var(--nurungji-brown); }
        .fab-btn:active { transform: scale(0.95); }
        .fab-report { background: var(--nurungji-yellow); color: var(--nurungji-dark); border-color: var(--nurungji-dark); }
        .fab-urgent { background: var(--urgent-color); color: #fff; border-color: #fff; font-size: 24px; box-shadow: 0 4px 15px rgba(255, 112, 67, 0.4); }
        
        .fab-profile { position: absolute; bottom: 30px; left: 15px; z-index: 20; width: 55px; height: 55px; background: #fff; border-radius: 24px; box-shadow: var(--shadow); display: flex; justify-content: center; align-items: center; font-size: 30px; cursor: pointer; border: 3px solid var(--nurungji-brown); transition: transform 0.2s; }
        .fab-profile:active { transform: scale(0.95); }
        .fab-lunchbox { position: absolute; bottom: 100px; left: 15px; z-index: 20; width: 50px; height: 50px; background: #fff; border-radius: 20px; box-shadow: var(--shadow); display: flex; justify-content: center; align-items: center; font-size: 26px; cursor: pointer; border: 2px solid var(--nurungji-brown); transition: transform 0.2s; }
        .fab-lunchbox:active { transform: scale(0.95); }

        .profile-overlay, .lunchbox-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(93, 64, 55, 0.5); z-index: 500; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        
        /* [ëˆ„ë£½ì§€ í…Œë§ˆ: í”„ë¡œí•„ ì¹´ë“œ] */
        .profile-card { width: 85%; max-width: 340px; background: var(--nurungji-bg); padding: 30px 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); position: relative; border: 4px solid var(--nurungji-brown); border-radius: 24px; }
        .pc-header { display: flex; justify-content: center; align-items: center; gap: 8px; margin-bottom: 5px; }
        .pc-nickname { color: var(--nurungji-dark); font-size: 22px; font-weight: 800; }
        .pc-edit-btn { cursor: pointer; font-size: 16px; background: rgba(255,255,255,0.5); width: 28px; height: 28px; border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 1px solid var(--nurungji-brown); }
        .pc-date { color: var(--nurungji-brown); font-size: 12px; font-weight: 600; margin-bottom: 12px; opacity: 0.8; }
        .pc-divider { height: 2px; background: var(--nurungji-brown); width: 40%; margin: 10px auto; border-radius: 1px; opacity: 0.3; }
        .pc-main-team { color: var(--nurungji-dark); font-size: 18px; font-weight: 700; margin-top: 8px; background: rgba(255,255,255,0.4); padding: 5px 10px; border-radius: 10px; display: inline-block; }
        /* [ìˆ˜ì •] ë„¤ì„ì¹´ë“œ í•˜ë‹¨ ë²„íŠ¼ ê·¸ë£¹ (ë‚˜ë€íˆ ë°°ì¹˜) */
        .pc-footer { display: flex; justify-content: center;gap: 10px; margin-top: 20px; width: 100%; }
        /* ì›Œí„°ë§ˆí¬ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .pc-rice-type { position: absolute; top: 12px; left: 15px; font-size: 11px; font-weight: 700; color: rgba(93, 64, 55, 0.25); pointer-events: none; }

        .login-section { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .input-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; }
        .auth-input { padding: 12px 15px; border-radius: 12px; border: 2px solid #d7ccc8; outline: none; font-size: 14px; background: white; color: var(--nurungji-dark); }
        .btn-row { display: flex; gap: 8px; }
        .btn-auth { flex: 1; padding: 12px; border-radius: 12px; border: none; cursor: pointer; font-weight: 700; font-size: 13px; color: var(--nurungji-dark); background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 2px solid var(--nurungji-brown); }
        .btn-google-login { background: white; color: var(--nurungji-dark); border: 2px solid var(--nurungji-brown); padding: 12px 20px; border-radius: 12px; font-weight: 700; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-google-login img { width: 18px; height: 18px; }
        /* ê¸°ì¡´ ì ˆëŒ€ìœ„ì¹˜ ì†ì„± ì œê±° ë° ìŠ¤íƒ€ì¼ í†µì¼ */
        .btn-logout, .pc-share-btn {
            position: static; /* ì ˆëŒ€ ìœ„ì¹˜ í•´ì œ */
            margin: 0;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .btn-logout { background: #d7ccc8; color: white; }
        .pc-share-btn { background: #8d6e63; color: white; }
        .btn-logout:active, .pc-share-btn:active { transform: scale(0.95); }
        .divider { color: var(--nurungji-brown); font-size: 11px; margin: 10px 0; display: flex; align-items: center; gap: 10px; }
        .divider::before, .divider::after { content: ""; flex: 1; height: 1px; background: var(--nurungji-brown); opacity: 0.5; }

        /* [ëˆ„ë£½ì§€ í…Œë§ˆ: ë„ì‹œë½ ë° ì‹ë‹¨í‘œ] */
        .lunchbox-wrapper {
            width: 330px;
            background: var(--nurungji-bg);
            border: 4px solid var(--nurungji-brown);
            border-radius: 20px;
            padding: 15px 10px;
            box-shadow: 0 12px 30px rgba(62, 39, 35, 0.4);
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: all 0.3s ease;
            max-height: 90vh;
        }
        .lb-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--nurungji-dark);
            font-weight: 800;
            font-size: 18px;
            padding: 0 5px;
        }
        /* ë²„íŠ¼ ê·¸ë£¹ */
        .lb-btn-group { display: flex; gap: 6px; }
        
        .lb-edit-btn, .lb-add-btn {
            background: white;
            border: 2px solid var(--nurungji-brown);
            color: var(--nurungji-dark);
            border-radius: 15px;
            padding: 4px 10px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 700;
        }
        .lb-edit-btn.editing { background: #ff7043; color: white; border-color: #d84315; }
        .lb-add-btn { background: #fff9c4; }

        .lunchbox-grid { 
            width: 100%; 
            height: 220px; 
            display: grid; 
            grid-template-columns: repeat(6, 1fr); 
            grid-template-rows: 0.8fr 1.2fr;
            gap: 6px; 
            flex-shrink: 0;
        }
        
        .lb-cell { 
            background: white; 
            border-radius: 12px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-size: 12px; 
            font-weight: 700; 
            color: var(--nurungji-dark); 
            text-align: center; 
            padding: 4px; 
            cursor: pointer; 
            transition: all 0.1s; 
            border: 2px solid #d7ccc8; 
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .lb-cell:active { transform: scale(0.98); }
        .lb-cell.selected { border: 2px solid var(--urgent-color); background: #ffecb3; }
        .lb-cell.empty { color: #bcaaa4; font-weight: 500; font-size: 11px; line-height: 1.4; border-style: dashed; background: #fffde7; }
        .lb-cell.filled { background: white; border-color: var(--nurungji-yellow); color: var(--nurungji-dark); }
        .lb-placeholder { display: block; }
        
        .lb-del-btn {
            position: absolute; top: -6px; right: -6px; width: 22px; height: 22px;
            background: #ff5252; color: white; border-radius: 50%;
            font-size: 14px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 10; border: 2px solid white;
        }

        .slot-2 { grid-row: 1; grid-column: 1 / span 2; } 
        .slot-3 { grid-row: 1; grid-column: 3 / span 2; } 
        .slot-4 { grid-row: 1; grid-column: 5 / span 2; } 
        .slot-0 { grid-row: 2; grid-column: 1 / span 3; } 
        .slot-1 { grid-row: 2; grid-column: 4 / span 3; } 

        .diet-toggle-btn {
            text-align: center;
            background: var(--nurungji-brown);
            color: white;
            font-weight: 700;
            padding: 10px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: background 0.2s;
        }
        .diet-toggle-btn:active { transform: scale(0.98); background: var(--nurungji-dark); }

        .diet-plan-container {
            width: 100%;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            height: 0;
            display: flex;
            flex-direction: column;
            border: 1px solid #d7ccc8;
            margin-top: 0;
            padding: 0 10px;
        }
        /* [ìˆ˜ì •] ì—´ë ¸ì„ ë•Œ íŒ¨ë”©ê³¼ ë§ˆì§„ ì ìš© */
        .diet-plan-container.open { padding: 10px; margin-top: 10px; }

        .diet-header-row {
            display: flex;
            height: 35px;
            border-bottom: 2px solid var(--nurungji-brown);
            background: #efebe9;
        }
        .diet-time-col {
            width: 40px;
            flex-shrink: 0;
            border-right: 1px solid #d7ccc8;
            background: #fff8e1;
        }
        .diet-time-col.header-corner { background: #d7ccc8; }
        .diet-day-col {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            font-weight: 700;
            color: var(--nurungji-dark);
            position: relative;
            border-right: 1px solid #efebe9;
        }
        .diet-day-col.header {
            background: #d7ccc8;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .diet-body-wrapper {
            flex: 1;
            display: flex;
            overflow-y: auto;
            position: relative;
            background: white;
        }
        .diet-time-label {
            display: flex; justify-content: center; align-items: flex-start;
            font-size: 10px; color: #8d6e63; padding-top: 2px;
            border-bottom: 1px solid #efebe9; font-weight: 600;
        }
        .diet-grid-line {
            width: 100%;
            border-bottom: 1px solid #f5f5f5;
            box-sizing: border-box;
        }
        .diet-event {
            position: absolute;
            font-size: 10px;
            color: #3e2723;
            padding: 2px 0; /* ì¢Œìš° íŒ¨ë”© ì œê±° */
            box-sizing: border-box;
            overflow: hidden;
            display: flex; 
            justify-content: center; /* ê°€ë¡œ ì¤‘ì•™ ì •ë ¬ */
            align-items: center; /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            line-height: 1.1;
        }
        .evt-title { 
            font-weight: 800; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis;
            writing-mode: vertical-rl; /* ì„¸ë¡œ ì“°ê¸° ëª¨ë“œ */
            text-orientation: upright; /* ê¸€ìë¥¼ ë˜‘ë°”ë¡œ ì„¸ì›€ */
            letter-spacing: 1px; /* ìê°„ ì¡°ì • */
        }
        .evt-time { font-size: 9px; opacity: 0.8; margin-top: 1px; }

        .label { padding: 6px 12px; background-color: #fff; border-radius: 20px; font-size: 12px; font-weight: 800; color: #333; box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: 1px solid rgba(0,0,0,0.1); white-space: nowrap; cursor: pointer; transform: translateY(-55px); }
        .label:hover { z-index: 10000 !important; transform: translateY(-57px) scale(1.05); }
        .label.urgent { background-color: var(--urgent-color); color: #fff; border: 2px solid #fff; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 71, 87, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); } }

        .bottom-sheet { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; z-index: 200; border-top-left-radius: 24px; border-top-right-radius: 24px; box-shadow: 0 -5px 25px rgba(0,0,0,0.15); display: flex; flex-direction: column; transition: height 0.1s linear; height: 0; overflow: hidden; }
        .sheet-handle-area { width: 100%; padding: 12px 0; display: flex; justify-content: center; cursor: grab; flex-shrink: 0; background: white; }
        .sheet-handle { width: 40px; height: 5px; background: #e0e0e0; border-radius: 3px; }
        .sheet-content-wrapper { flex: 1; overflow-y: auto; padding: 0 24px 20px 24px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .sheet-content-wrapper::-webkit-scrollbar { display: none; }

        .urgent-banner { margin-bottom: 15px; padding: 12px; background: #fff3e0; border: 1px solid #ffcc80; border-radius: 12px; color: #e64a19; font-size: 14px; font-weight: 700; display: flex; align-items: center; gap: 8px; line-height: 1.4; }
        .sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; margin-top: 10px; }
        .sheet-title { font-size: 22px; font-weight: 800; color: #111; margin: 0; display: flex; align-items: center; gap: 8px; flex: 1; }
        .instagram { font-size: 26px; width: 1em; height: 1em; display: inline-grid; place-items: center; vertical-align: middle; background: radial-gradient(circle farthest-corner at 28% 100%, #fcdf8f 0%, #fbd377 10%, #fa8e37 22%, #f73344 35%, transparent 65%), linear-gradient(145deg, #3051f1 10%, #c92bb7 70%); border-radius: 0.25em; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
        .instagram:before { content: ""; position: absolute; border-radius: inherit; aspect-ratio: 1; border: 0.08em solid var(--white); width: 65%; height: 65%; border-radius: 25%; }
        .instagram:after { content: ""; position: absolute; border-radius: 50%; aspect-ratio: 1; border: 0.08em solid var(--white); width: 35%; height: 35%; box-shadow: 0.22em -0.22em 0 -0.18em var(--white); }

        .time-morph-container { position: relative; background: transparent; margin-bottom: 20px; transition: height 0.1s linear; overflow: hidden; min-height: 60px; border: none; }
        .st-bubble { background: #fff; border-radius: 12px; padding: 6px 16px; font-size: 13px; color: #333; white-space: nowrap; font-weight: 600; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 2px solid var(--nurungji-yellow); box-shadow: 0 4px 10px rgba(250, 199, 16, 0.15); flex-shrink: 0; }
        .st-day-text { font-size: 12px; color: #f57f17; font-weight: 800; margin-bottom: 2px; }
        .st-time-text { font-size: 14px; font-weight: 700; color: #333; }
        .summary-content { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; gap: 8px; overflow-x: auto; align-items: center; padding: 5px; scrollbar-width: none; opacity: 1; transition: opacity 0.1s; z-index: 10; }
        .summary-content::-webkit-scrollbar { display: none; }
        .full-content { position: absolute; top: 0; left: 0; width: 100%; opacity: 0; transition: opacity 0.1s; z-index: 5; }
        
        .ft-container { display: flex; flex-direction: column; background: #fff; border-radius: 16px; overflow: hidden; border: 1px solid #d7ccc8; }
        .ft-header-row-flex { display: flex; height: 35px; border-bottom: 2px solid var(--nurungji-brown); background: #efebe9; }
        .ft-header-cell { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 11px; color: var(--nurungji-brown); font-weight: 700; }
        .ft-header-cell.time-col { width: 50px; flex: none; border-right: 1px solid #d7ccc8; background: #fff8e1; }
        .ft-header-cell.today { background: var(--today-color); color: #fff; font-weight: 800; }
        .ft-body { display: flex; position: relative; }
        .ft-col-time { width: 50px; flex: none; display: flex; flex-direction: column; border-right: 1px solid #d7ccc8; background: #fff8e1; }
        .ft-time-label { display: flex; flex-direction: row; gap: 2px; align-items: center; justify-content: center; font-size: 11px; color: #8d6e63; font-weight: 600; border-bottom: 1px solid #efebe9; white-space: nowrap; }
        .ft-col-day { flex: 1; position: relative; border-right: 1px solid #efebe9; }
        .ft-col-day:last-child { border-right: none; }
        .ft-event-block { position: absolute; width: 94%; left: 3%; background: #fff9c4; border-left: 4px solid var(--nurungji-yellow); border-radius: 6px; font-size: 10px; color: #3e2723; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; font-weight: 700; line-height: 1.2; z-index: 5; box-shadow: 0 2px 4px rgba(0,0,0,0.05); padding: 2px; overflow: hidden; }

        .tag-box { display: flex; gap: 6px; margin-bottom: 20px; flex-wrap: wrap; }
        .tag { font-size: 12px; padding: 6px 10px; border-radius: 8px; font-weight: 600; color: #5d4037; background: #efebe9; }
        .tag.target { color: #e65100; background: #fff3e0; }
        .info-row { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; font-size: 15px; color: #333; }
        .info-icon { width: 20px; text-align: center; font-size: 16px; }
        .action-buttons { display: flex; gap: 12px; margin-top: 20px; }
        .btn { flex: 1; padding: 14px; border-radius: 14px; border: none; font-size: 15px; font-weight: 700; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 6px; text-decoration: none; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-copy { background: #eceff1; color: #455a64; }
        .btn-way { background: var(--nurungji-yellow); color: var(--nurungji-dark); box-shadow: 0 4px 10px rgba(250, 199, 16, 0.3); }
        a.insta-link { text-decoration: none; display: flex; align-items: center; }

        .filter-sheet { position: fixed; top: 0; left: 0; width: 100%; max-height: 85%; background: white; z-index: 300; border-radius: 0 0 24px 24px; box-shadow: 0 5px 30px rgba(0,0,0,0.2); padding: 0; transform: translateY(-100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); display: flex; flex-direction: column; will-change: transform; border-bottom: 4px solid var(--nurungji-brown); }
        .filter-sheet.active { transform: translateY(0); }
        .fs-header { padding: 20px 24px 15px; display: flex; justify-content: space-between; align-items: center; }
        .fs-title { font-size: 20px; font-weight: 800; color: var(--nurungji-dark); }
        .fs-body { flex: 1; overflow-y: auto; padding: 0 24px 10px; }
        .fs-section { margin-bottom: 25px; }
        .fs-label { font-size: 14px; font-weight: 700; color: #8d6e63; margin-bottom: 10px; display: block; }
        .chip-group { display: flex; flex-wrap: wrap; gap: 8px; }
        .chip { padding: 8px 16px; border-radius: 20px; border: 2px solid #e0e0e0; background: #fff; font-size: 14px; color: #757575; font-weight: 600; cursor: pointer; transition: all 0.2s; user-select: none; }
        .chip:hover { background: #f5f5f5; }
        .chip.selected { background: var(--nurungji-yellow); color: var(--nurungji-dark); border-color: var(--nurungji-brown); box-shadow: 0 2px 6px rgba(250, 199, 16, 0.3); font-weight: 700; }
        .fs-footer { padding: 10px 24px 10px; border-top: 1px solid #eee; display: flex; gap: 10px; background: white; }
        .btn-reset { flex: 0.3; background: #f5f5f5; color: #757575; }
        .btn-apply { flex: 1; background: var(--nurungji-dark); color: white; }
        .fs-handle-area { width: 100%; padding: 10px 0 20px 0; display: flex; justify-content: center; cursor: grab; background: white; border-radius: 0 0 24px 24px; }
        .fs-handle { width: 40px; height: 5px; background: #bdbdbd; border-radius: 3px; }
        
        .expand-hint { text-align: center; color: #bdbdbd; font-size: 11px; margin-top: 5px; margin-bottom: 0px; }

        /* [ìˆ˜ì •] ìº¡ì²˜ ë¬´ëŒ€ (ê²¹ì¹¨ ë°©ì§€ë¥¼ ìœ„í•´ transform ì œê±°) */
        #captureStage {
            position: fixed; top: 0; left: 0; 
            z-index: -9999;
            background-color: #fff8e1;
            font-family: "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
            display: flex; 
            visibility: hidden;
        }

        /* [ìˆ˜ì •] ì›Œí„°ë§ˆí¬ (ë¡œê³  ì´ë¯¸ì§€ í¬í•¨) */
        .watermark {
            position: absolute; bottom: 40px; right: 50px;
            display: flex; align-items: center; gap: 15px;
            opacity: 0.8;
        }
        .watermark img { width: 50px; height: 50px; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .watermark span { font-size: 32px; font-weight: 900; color: #5d4037; letter-spacing: -1px; }

        /* [ìˆ˜ì •] ìŠ¤í† ë¦¬ ëª¨ë“œ (ì„¸ë¡œí˜•) - ê°„ê²© ë„“í˜ */
        .mode-story {
            width: 1080px; height: 1920px;
            padding: 120px;
            flex-direction: column; /* ì„¸ë¡œ ë°°ì¹˜ */
            align-items: center; justify-content: center;
            gap: 80px; /* ìš”ì†Œ ê°„ ê°„ê²© */
            background-image: radial-gradient(#fff9c4 15%, transparent 15%);
            background-size: 50px 50px;
        }
        /* transform ì œê±°í•˜ê³  ì¤Œì´ë‚˜ í¬ê¸° ìì²´ë¥¼ ì œì–´ (ì—¬ê¸°ì„  html2canvas scale í™œìš©í•˜ë¯€ë¡œ ê·¸ëƒ¥ ë‘ ) */
        .mode-story .cap-card { transform: scale(1.8); box-shadow: 0 20px 60px rgba(0,0,0,0.15); border-radius: 40px; }
        .mode-story .cap-box { transform: scale(1.8); box-shadow: 0 20px 60px rgba(0,0,0,0.15); width: 350px !important; }

        /* [ìˆ˜ì •] í”¼ë“œ ëª¨ë“œ (4:5) - ë ˆì´ì•„ì›ƒ ì•ˆì •í™” */
        .mode-feed {
            width: 1080px; height: 1350px;
            padding: 60px;
            flex-direction: row; /* ê°€ë¡œ ë°°ì¹˜ */
            align-items: center; justify-content: center; gap: 50px;
            background: #fff3e0;
            border: 60px solid #8d6e63;
            box-sizing: border-box; /* í…Œë‘ë¦¬ í¬í•¨ í¬ê¸° ê³„ì‚° */
        }
        .feed-col-left { 
            display: flex; flex-direction: column; gap: 60px; 
            align-items: center; justify-content: center;
            flex: 1;
        }
        .feed-col-left .cap-card { transform: scale(1.5); box-shadow: 0 15px 40px rgba(0,0,0,0.1); }
        .feed-col-left .cap-box { transform: scale(1.5); box-shadow: 0 15px 40px rgba(0,0,0,0.1); width: 330px !important; }
        
        .feed-col-right {
            width: 450px; height: 90%;
            background: white; border-radius: 30px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.1);
            overflow: hidden; display: flex; flex-direction: column;
            border-top: 20px solid #fac710;
        }
        .pc-share-btn:active { transform: scale(0.95); }

        /* [NEW] ìº¡ì²˜ìš© ìˆ¨ê²¨ì§„ ë¬´ëŒ€ (ì•ˆì •ì„± ê°œì„ ) */
        #captureStage {
            position: fixed; top: 0; left: 0; 
            z-index: -9999; /* í™”ë©´ ë’¤ë¡œ ìˆ¨ê¹€ */
            background-color: #fff8e1;
            font-family: "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
            display: flex; flex-direction: column;
            visibility: hidden; /* display:none ëŒ€ì‹  visibility ì‚¬ìš© (ë Œë”ë§ ë³´ì¥) */
        }

        /* ì›Œí„°ë§ˆí¬ */
        .watermark {
            position: absolute; bottom: 30px; right: 40px;
            font-size: 24px; font-weight: 900; color: #5d4037; opacity: 0.5;
            display: flex; align-items: center; gap: 8px;
        }

        /* Option A: ìŠ¤í† ë¦¬ ëª¨ë“œ (9:16) */
        .mode-story {
            width: 1080px; height: 1920px;
            padding: 100px;
            align-items: center; justify-content: center;
            gap: 60px;
            background-image: radial-gradient(#fff9c4 15%, transparent 15%);
            background-size: 40px 40px;
        }
        .mode-story .cap-card { transform: scale(2.5); margin-bottom: 60px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); border-radius: 40px; }
        .mode-story .cap-box { transform: scale(2.5); box-shadow: 0 20px 60px rgba(0,0,0,0.15); width: 330px !important; }

        /* Option B: í”¼ë“œ ëª¨ë“œ (4:5) */
        .mode-feed {
            width: 1080px; height: 1350px;
            padding: 80px;
            display: flex; flex-direction: row;
            align-items: center; justify-content: center; gap: 60px;
            background: #fff3e0;
            border: 50px solid #8d6e63;
        }
        .feed-col-left { 
            display: flex; flex-direction: column; gap: 80px; 
            align-items: center; justify-content: center;
        }
        .feed-col-left .cap-card { transform: scale(2.0); box-shadow: 0 15px 40px rgba(0,0,0,0.1); }
        .feed-col-left .cap-box { transform: scale(2.0); box-shadow: 0 15px 40px rgba(0,0,0,0.1); }
        
        .feed-col-right {
            width: 420px; height: 90%;
            background: white; border-radius: 30px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.1);
            overflow: hidden; display: flex; flex-direction: column;
            border-top: 15px solid #fac710;
        }
        .feed-header {
            padding: 30px; text-align: center; font-size: 32px; font-weight: 800; color: #5d4037;
            border-bottom: 4px dashed #efebe9;
        }

        /* ë¯¸ë¦¬ë³´ê¸° ì°½ */
        .preview-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .preview-img-box {
            max-width: 85%; max-height: 75%;
            overflow: hidden; border-radius: 16px; margin-bottom: 20px;
            box-shadow: 0 0 30px rgba(255,255,255,0.1);
        }
        .preview-img-box img { width: 100%; height: auto; display: block; }
        .preview-btns { display: flex; gap: 20px; }
        .btn-down { background: #fac710; color: #000; padding: 14px 28px; border-radius: 30px; font-weight: 800; border: none; cursor: pointer; font-size: 16px; }
        .btn-close { background: white; color: #333; padding: 14px 28px; border-radius: 30px; font-weight: 700; border: none; cursor: pointer; font-size: 16px; }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="search-container">
        <div class="search-icon-box">ğŸ”</div>
        <input type="text" id="topSearchInput" class="main-search-input" placeholder="íŒ€ëª…, ì§€ì—­ìœ¼ë¡œ ê²€ìƒ‰..." onkeyup="applyFilters()">
        <div class="separator"></div>
        <div class="filter-btn-icon" onclick="openFilterSheet()">âš™ï¸<div id="filterBadge" class="filter-badge"></div></div>
    </div>

    <div id="urgentTicker" class="urgent-ticker-bar">
        <div class="ticker-icon">ğŸ”¥</div>
        <div class="ticker-content">
            <ul id="tickerList" class="ticker-list"></ul>
        </div>
    </div>

    <div class="fab-lunchbox" onclick="openLunchbox()">ğŸ±</div>
    <div class="fab-profile" onclick="toggleProfileCard()">ğŸš</div>

    <div class="fab-group">
        <a href="https://forms.gle/PiNXA5QkxKoPQyix6" target="_blank" class="fab-btn fab-urgent" title="ì‹­ì‹œì¼ë°˜ ê¸´ê¸‰êµ¬ì¸ ì‹ ì²­">ğŸ¥„</a>
        <a href="https://forms.gle/H6HoEUy5zM7FHuHL7" target="_blank" class="fab-btn fab-report" title="íŒ€ ì œë³´í•˜ê¸°">ğŸ“¢</a>
        <div class="fab-btn" onclick="moveToMyLocation()">ğŸ“</div>
    </div>

    <div id="lunchboxOverlay" class="lunchbox-overlay">
        <div class="lunchbox-wrapper">
            <div class="lb-header">
                <span>ë„ì‹œë½ ğŸ±</span>
                <div class="lb-btn-group">
                    <button class="lb-add-btn" onclick="addCustomTeam()">ğŸ™ ì§ì ‘ì¶”ê°€</button>
                    <button id="lbEditBtn" class="lb-edit-btn" onclick="toggleEditMode()">ğŸ½ í¸ì§‘</button>
                </div>
            </div>
            <div class="lunchbox-grid" id="lunchboxGrid"></div>
            
            <div id="dietToggleBtn" class="diet-toggle-btn" onclick="toggleDietPlan()">ğŸ“… ì‹ë‹¨í‘œ (ìŠ¤ì¼€ì¤„ í™•ì¸)</div>
            <div id="dietPlanContainer" class="diet-plan-container">
                <div id="dietPlanBody" style="flex:1; display:flex; flex-direction:column; overflow:hidden;"></div>
            </div>
        </div>
    </div>

    <div id="profileOverlay" class="profile-overlay" onclick="toggleProfileCard()">
        <div class="profile-card" id="myProfileCard" onclick="event.stopPropagation()">
            <div id="pcRiceWatermark" class="pc-rice-type"></div>
            <div id="loginSection" class="login-section">
                <button class="btn-google-login" onclick="loginWithGoogle()">
                    <img src="https://fonts.gstatic.com/s/i/productlogos/googleg/v6/24px.svg" alt="G">
                    êµ¬ê¸€ë¡œ ê°„í¸ ë¡œê·¸ì¸
                </button>
                <div class="divider">ë˜ëŠ”</div>
                <div class="input-group">
                    <input type="email" id="emailInput" class="auth-input" placeholder="ì´ë©”ì¼ ì…ë ¥">
                    <input type="password" id="pwInput" class="auth-input" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ìë¦¬ ì´ìƒ)">
                </div>
                <div class="btn-row">
                    <button class="btn-auth primary" onclick="loginWithEmail()">ë¡œê·¸ì¸</button>
                    <button class="btn-auth secondary" onclick="registerWithEmail()">íšŒì›ê°€ì…</button>
                </div>
            </div>
            <div id="profileContent" style="display:none;">
                <div class="pc-header">
                    <span id="pcNickname" class="pc-nickname">...</span>
                    <div class="pc-edit-btn" onclick="editNickname()">ğŸ¥¢</div>
                </div>
                <div id="pcDate" class="pc-date">ê°€ì…ì¼: -</div>
                <div class="pc-divider"></div>
                <div id="pcMainTeam" class="pc-main-team">ì°œí•œ íŒ€ì´ ì—†ì–´ìš”</div>
                
                <div class="pc-footer">
                    <button class="btn-logout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                    <div class="pc-share-btn" onclick="showShareOptions()">ğŸ í¬ì¥í•˜ê¸°</div>
                </div>
            </div>
        </div>
    </div>

    <div id="filterSheet" class="filter-sheet">
        <div class="fs-header"><div class="fs-title">ê²€ìƒ‰ ì¡°ê±´ ì„¤ì •</div></div>
        <div class="fs-body">
            <div class="fs-section"><span class="fs-label">ğŸ“ ì§€ì—­ (ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥)</span>
                <div class="chip-group" id="regionChips">
                    <div class="chip" onclick="toggleFilter('region', 'ì„œìš¸', this)">ì„œìš¸</div>
                    <div class="chip" onclick="toggleFilter('region', 'ê²½ê¸°', this)">ê²½ê¸°</div>
                    <div class="chip" onclick="toggleFilter('region', 'ì¸ì²œ', this)">ì¸ì²œ</div>
                    <div class="chip" onclick="toggleFilter('region', 'ê°•ì›', this)">ê°•ì›</div>
                    <div class="chip" onclick="toggleFilter('region', 'ì¶©ì²­', this)">ì¶©ì²­</div>
                    <div class="chip" onclick="toggleFilter('region', 'ì „ë¼', this)">ì „ë¼</div>
                    <div class="chip" onclick="toggleFilter('region', 'ê²½ìƒ', this)">ê²½ìƒ</div>
                    <div class="chip" onclick="toggleFilter('region', 'ì œì£¼', this)">ì œì£¼</div>
                </div>
            </div>
            <div class="fs-section"><span class="fs-label">ğŸ“… ìš”ì¼</span>
                <div class="chip-group" id="dayChips">
                    <div class="chip" onclick="toggleFilter('day', 'ì›”', this)">ì›”</div>
                    <div class="chip" onclick="toggleFilter('day', 'í™”', this)">í™”</div>
                    <div class="chip" onclick="toggleFilter('day', 'ìˆ˜', this)">ìˆ˜</div>
                    <div class="chip" onclick="toggleFilter('day', 'ëª©', this)">ëª©</div>
                    <div class="chip" onclick="toggleFilter('day', 'ê¸ˆ', this)">ê¸ˆ</div>
                    <div class="chip" onclick="toggleFilter('day', 'í† ', this)">í† </div>
                    <div class="chip" onclick="toggleFilter('day', 'ì¼', this)">ì¼</div>
                </div>
            </div>
            <div class="fs-section"><span class="fs-label">ğŸ ëŒ€ìƒ ë° íŠ¹ì§•</span>
                <div class="chip-group" id="targetChips">
                    <div class="chip" onclick="toggleFilter('target', 'ì„±ì¸', this)">ì„±ì¸</div>
                    <div class="chip" onclick="toggleFilter('target', 'ëŒ€í•™ìƒ', this)">ëŒ€í•™ìƒ</div>
                    <div class="chip" onclick="toggleFilter('target', 'ì²­ì†Œë…„', this)">ì²­ì†Œë…„</div>
                    <div class="chip" onclick="toggleFilter('target', 'ì—¬ì„±ì „ìš©', this)">ì—¬ì„±ì „ìš©</div>
                    <div class="chip" onclick="toggleFilter('target', 'ë‚¨ì„±ì „ìš©', this)">ë‚¨ì„±ì „ìš©</div>
                    <div class="chip" onclick="toggleFilter('target', 'ì„ ì¶œê°€ëŠ¥', this)">ì„ ì¶œê°€ëŠ¥</div>
                    <div class="chip" onclick="toggleFilter('target', '6ì¸ì œ', this)">6ì¸ì œ</div>
                </div>
            </div>
        </div>
        <div class="fs-footer">
            <div class="btn btn-reset" onclick="resetFilters()">ì´ˆê¸°í™”</div>
            <div class="btn btn-apply" onclick="applyFilters()">ì ìš©í•˜ê¸°</div>
        </div>
        <div class="fs-handle-area" id="filterHandle"><div class="fs-handle"></div></div>
    </div>

    <div id="bottomSheet" class="bottom-sheet">
        <div class="sheet-handle-area" id="sheetHandle"><div class="sheet-handle"></div></div>
        
        <div class="sheet-content-wrapper">
            <div id="urgentArea"></div>

            <div class="sheet-header">
                <div class="sheet-title" id="sheetTitle">íŒ€ ì´ë¦„</div>
                <div id="btnBookmark" style="font-size:24px; cursor:pointer;" onclick="">ğŸ±</div>
            </div>
            
            <div class="time-morph-container" id="timeMorphContainer" onclick="toggleTimeExpand()">
                <div class="summary-content" id="summaryContent"></div>
                <div class="full-content" id="fullContent"></div>
            </div>
            
            <div class="tag-box" id="sheetTags"></div>
            <div class="info-row"><span class="info-icon">ğŸ’°</span> <span id="sheetPrice">-</span></div>
            
            <div class="action-buttons">
                <button class="btn btn-copy" id="btnCopy">ğŸ“ ì£¼ì†Œ ë³µì‚¬</button>
                <a href="#" target="_blank" class="btn btn-way" id="btnWay">ğŸš€ ê¸¸ì°¾ê¸°</a>
            </div>
            
            <div class="expand-hint" id="expandHint">â–´ ìœ„ë¡œ ì˜¬ë ¤ì„œ ìƒì„¸ ì •ë³´ ë³´ê¸°</div>
            <input type="hidden" id="sheetAddressVal">
        </div>
    </div>

    <div id="captureStage"></div>

    <div id="previewOverlay" class="preview-overlay">
        <div class="preview-img-box" id="previewImgBox"></div>
        <div class="preview-btns">
            <button class="btn-close" onclick="closePreview()">ë‹«ê¸°</button>
            <button class="btn-down" onclick="downloadImage()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
        </div>
    </div>

    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=__KAKAO_JS_KEY__&libraries=clusterer"></script>
    <script>
        var mapContainer = document.getElementById('map'), 
            mapOption = { center: new kakao.maps.LatLng(__CENTER_LAT__, __CENTER_LNG__), level: 8 }; 
        var map = new kakao.maps.Map(mapContainer, mapOption); 
        
        var clusterer = new kakao.maps.MarkerClusterer({
            map: map, averageCenter: true, minLevel: 6,
            styles: [{
                width: '40px', height: '40px', background: '#fac710', borderRadius: '50%', color: '#000', textAlign: 'center', fontWeight: 'bold', lineHeight: '40px', boxShadow: '0 2px 6px rgba(0,0,0,0.3)', fontSize: '14px'
            }]
        });

        // í´ëŸ½ ë°ì´í„° ì£¼ì…
        var clubs = __CLUBS_JSON__;
        var markers = []; 
        
        var defaultImageSrc = './marker_yellow.png'; 
        var urgentImageSrc = './marker_red.png'; 
        var imageSize = new kakao.maps.Size(40, 53); 
        var imageOption = {offset: new kakao.maps.Point(20, 53)}; 
        
        var defaultMarkerImage = new kakao.maps.MarkerImage(defaultImageSrc, imageSize, imageOption);
        var urgentMarkerImage = new kakao.maps.MarkerImage(urgentImageSrc, imageSize, imageOption);

        var gpsSvg = 'data:image/svg+xml;charset=UTF-8,%3csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3e%3ccircle cx="50" cy="50" r="45" fill="rgba(66, 133, 244, 0.3)"/%3e%3ccircle cx="50" cy="50" r="25" fill="white"/%3e%3ccircle cx="50" cy="50" r="20" fill="%234285F4"/%3e%3c/svg%3e';
        var gpsImage = new kakao.maps.MarkerImage(gpsSvg, new kakao.maps.Size(44,44), {offset: new kakao.maps.Point(22,22)});
        var myMarker = null;
        var instaCssIcon = '<div class="instagram" title="ì¸ìŠ¤íƒ€ê·¸ë¨ ë³´ëŸ¬ê°€ê¸°"></div>';

        clubs.forEach(function(club) {
            if (!club.lat || !club.lng) return;
            var latlng = new kakao.maps.LatLng(club.lat, club.lng);
            var marker;
            if (club.is_urgent) {
                marker = new kakao.maps.Marker({ position: latlng, image: urgentMarkerImage, zIndex: 9999 });
                marker.setMap(map); 
            } else {
                marker = new kakao.maps.Marker({ position: latlng, image: defaultMarkerImage });
            }
            
            var labelClass = club.is_urgent ? 'label urgent' : 'label';
            var iconHtml = club.is_urgent ? 'ğŸ”¥ ' : '';
            var content = '<div class="' + labelClass + '" onclick="triggerMarkerClick(\'' + club.id + '\')">' + iconHtml + club.name + '</div>';
            var xAnc = 0.5; var yAnc = 1;   
            if (club.angle !== undefined) { xAnc = 0.5 - (Math.cos(club.angle) * 0.5); }
            var customOverlay = new kakao.maps.CustomOverlay({ position: latlng, content: content, xAnchor: xAnc, yAnchor: yAnc, zIndex: 9999 });
            
            if (club.is_urgent) { customOverlay.setMap(map); }
            kakao.maps.event.addListener(marker, 'click', function() { openClubDetail(club.id); });
            
            markers.push({ marker: marker, overlay: customOverlay, club: club, isVisible: true });
        });

        var initialClusterMarkers = [];
        markers.forEach(function(item) {
            if (!item.club.is_urgent) { initialClusterMarkers.push(item.marker); }
        });
        clusterer.addMarkers(initialClusterMarkers);

        function triggerMarkerClick(id) {
            var target = markers.find(m => m.club.id === id);
            if (target && target.marker) kakao.maps.event.trigger(target.marker, 'click');
        }

        function updateLabelVisibility() {
            var level = map.getLevel(); 
            var showNormalLabels = (level <= 5); 
            var showUrgentLabels = (level <= 8); 
            markers.forEach(function(item) {
                if (!item.isVisible) return; 
                if (item.club.is_urgent) { 
                    if (showUrgentLabels) item.overlay.setMap(map); else item.overlay.setMap(null);
                } else { 
                    if (showNormalLabels) item.overlay.setMap(map); else item.overlay.setMap(null); 
                }
            });
        }
        
        kakao.maps.event.addListener(map, 'zoom_changed', updateLabelVisibility);

        function parseScheduleText(text) {
            var scheduleMap = {};
            if (!text) return scheduleMap;
            // ì—­ìŠ¬ë˜ì‹œ í•œ ë²ˆë§Œ ì‚¬ìš© (ìˆ˜ì •ë¨)
            var segments = text.split(/\s*\/\s*/); 
            segments.forEach(function(segment) {
                // ì—­ìŠ¬ë˜ì‹œ í•œ ë²ˆë§Œ ì‚¬ìš© (ìˆ˜ì •ë¨)
                var timeReg = /(\d{1,2}):(\d{2})\s*[~-]\s*(\d{1,2}):(\d{2})/;
                var match = segment.match(timeReg);
                if (match) {
                    var startH = parseInt(match[1]);
                    var startM = parseInt(match[2]);
                    var endH = parseInt(match[3]);
                    var endM = parseInt(match[4]);
                    
                    function format12(h, m) {
                        var p = h >= 12 ? 'PM' : 'AM';
                        var h12 = h % 12;
                        if (h12 === 0) h12 = 12;
                        var mStr = m < 10 ? '0'+m : m;
                        return p + ' ' + h12 + ':' + mStr;
                    }
                    
                    var displayTime = format12(startH, startM) + '~' + format12(endH, endM);
                    
                    var days = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
                    days.forEach(function(day) {
                        if (segment.includes(day)) {
                            scheduleMap[day] = { 
                                startH: startH, startM: startM, 
                                endH: endH, endM: endM, 
                                text: displayTime 
                            };
                        }
                    });
                }
            });
            return scheduleMap;
        }

        function getHourLabel(h) {
            var p = h >= 12 ? 'PM' : 'AM';
            var h12 = h % 12;
            if (h12 === 0) h12 = 12;
            return p + ' ' + h12;
        }

        function renderTimetables(scheduleText) {
            var scheduleData = parseScheduleText(scheduleText);
            var days = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
            var dayIndices = {'ì¼':0, 'ì›”':1, 'í™”':2, 'ìˆ˜':3, 'ëª©':4, 'ê¸ˆ':5, 'í† ':6};
            var todayIndex = new Date().getDay(); 
            var todayChar = Object.keys(dayIndices).find(key => dayIndices[key] === todayIndex);

            var minH = 24, maxH = 0;
            var hasData = false;
            
            Object.values(scheduleData).forEach(function(data) {
                if (data.startH < minH) minH = data.startH;
                if (data.endH > maxH) maxH = data.endH;
                hasData = true;
            });

            if (!hasData) { minH = 18; maxH = 22; }
            
            var displayStart = Math.max(6, minH - 1); 
            var displayEnd = Math.min(24, maxH + 1);
            var totalHours = displayEnd - displayStart;

            // [ìˆ˜ì • í•µì‹¬] í™”ë©´ ë†’ì´ì— ë§ì¶° í–‰ ë†’ì´ ìë™ ì¡°ì ˆ (ìŠ¤í¬ë¡¤ ë°©ì§€)
            // í™”ë©´ ë†’ì´ì˜ 50% ì •ë„ë¥¼ í• ë‹¹í•˜ê³ , ì‹œê°„ì— ë”°ë¼ ë‚˜ëˆ”
            var availableHeight = window.innerHeight * 0.5; 
            var calculatedRowHeight = availableHeight / totalHours;
            // ìµœì†Œ ë†’ì´ 25pxì€ ë³´ì¥í•˜ë˜, ë„ˆë¬´ ì»¤ì§€ì§€ë„ ì•Šê²Œ ì„¤ì •
            var ROW_HEIGHT = Math.max(25, Math.min(50, calculatedRowHeight));

            var summaryContainer = document.getElementById('summaryContent');
            summaryContainer.innerHTML = '';
            var hasActive = false;
            days.forEach(function(day) {
                var data = scheduleData[day];
                if (data) {
                    hasActive = true;
                    var item = document.createElement('div');
                    item.className = 'st-bubble active';
                    item.innerHTML = '<div class="st-day-text">' + day + 'ìš”ì¼</div><div class="st-time-text">' + data.text + '</div>';
                    summaryContainer.appendChild(item);
                }
            });
            if (!hasActive) {
                summaryContainer.innerHTML = '<div class="st-bubble"><div class="st-day-text">ì¼ì •</div><div class="st-time-text">ì •ë³´ì—†ìŒ</div></div>';
            }

            var fullContainer = document.getElementById('fullContent');
            fullContainer.innerHTML = '';
            
            var ftContainer = document.createElement('div');
            ftContainer.className = 'ft-container';
            
            var headerRow = document.createElement('div');
            headerRow.className = 'ft-header-row-flex';
            var emptyCell = document.createElement('div'); emptyCell.className = 'ft-header-cell time-col';
            headerRow.appendChild(emptyCell);
            
            days.forEach(function(d) {
                var cell = document.createElement('div');
                cell.className = 'ft-header-cell';
                if (d === todayChar) cell.className += ' today';
                cell.innerText = d;
                headerRow.appendChild(cell);
            });
            ftContainer.appendChild(headerRow);

            var bodyRow = document.createElement('div');
            bodyRow.className = 'ft-body';
            // ì „ì²´ ë†’ì´ë¥¼ ë‚´ìš©ë¬¼ì— ë”± ë§ì¶¤
            bodyRow.style.height = (totalHours * ROW_HEIGHT) + 'px';

            var timeCol = document.createElement('div');
            timeCol.className = 'ft-col-time';
            for(var h = displayStart; h < displayEnd; h++) {
                var label = document.createElement('div');
                label.className = 'ft-time-label';
                label.style.height = ROW_HEIGHT + 'px'; 
                label.innerHTML = getHourLabel(h);
                timeCol.appendChild(label);
            }
            bodyRow.appendChild(timeCol);

            days.forEach(function(d) {
                var dayCol = document.createElement('div');
                dayCol.className = 'ft-col-day';
                
                for(var h = displayStart; h < displayEnd; h++) {
                    var gridLine = document.createElement('div');
                    gridLine.style.height = ROW_HEIGHT + 'px'; 
                    gridLine.style.borderBottom = '1px solid #f8f8f8';
                    gridLine.style.boxSizing = 'border-box';
                    dayCol.appendChild(gridLine);
                }

                var data = scheduleData[d];
                if (data) {
                    var startTotalHours = data.startH + (data.startM / 60) - displayStart;
                    var durationHours = (data.endH + (data.endM / 60)) - (data.startH + (data.startM / 60));
                    
                    var topPx = startTotalHours * ROW_HEIGHT;
                    var heightPx = durationHours * ROW_HEIGHT;

                    var duration = (data.endH + (data.endM / 60)) - (data.startH + (data.startM / 60));
                    var durationStr = Number.isInteger(duration) ? duration : duration.toFixed(1);

                    if (topPx >= 0) {
                        var block = document.createElement('div');
                        block.className = 'ft-event-block';
                        block.style.top = topPx + 'px';
                        block.style.height = (heightPx - 2) + 'px'; 
                        block.innerHTML = data.text.replace('~', '<br>~<br>') + 
                                          '<div style="font-size:9px; opacity:0.8; margin-top:2px;">(' + durationStr + 'h)</div>';
                        dayCol.appendChild(block);
                    }
                }
                bodyRow.appendChild(dayCol);
            });
            
            ftContainer.appendChild(bodyRow);
            fullContainer.appendChild(ftContainer);
        }

        var sheetState = 'PEEK'; 
        var PEEK_HEIGHT = 390; 
        var EXPANDED_HEIGHT = window.innerHeight * 0.9;
        var BUBBLE_HEIGHT = 60;

        function updateSheetState(newState, animation = true) {
            var sheet = document.getElementById('bottomSheet');
            var hint = document.getElementById('expandHint');
            
            sheetState = newState;
            
            if (animation) sheet.style.transition = 'height 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)';
            else sheet.style.transition = 'none';

            if (newState === 'CLOSED') {
                sheet.style.height = '0';
            } 
            else if (newState === 'PEEK') {
                sheet.style.height = PEEK_HEIGHT + 'px';
                hint.innerText = 'â–´ ìœ„ë¡œ ì˜¬ë ¤ì„œ ìƒì„¸ ì •ë³´ ë³´ê¸°';
                interpolateMorph(0); 
            } 
            else if (newState === 'EXPANDED') {
                sheet.style.height = EXPANDED_HEIGHT + 'px';
                hint.innerText = 'â–¾ ì•„ë˜ë¡œ ë‚´ë ¤ì„œ ìš”ì•½ ë³´ê¸°';
                interpolateMorph(1); 
            }
        }

        function interpolateMorph(ratio) {
            var summary = document.getElementById('summaryContent');
            var full = document.getElementById('fullContent');
            var container = document.getElementById('timeMorphContainer');
            
            ratio = Math.min(Math.max(ratio, 0), 1);

            if (ratio > 0.8) {
                container.style.height = 'auto'; 
                full.style.position = 'relative'; 
            } else {
                 var targetH = BUBBLE_HEIGHT + (350 * ratio); 
                 container.style.height = targetH + 'px';
                 full.style.position = 'absolute'; 
            }

            if (ratio < 0.5) {
                summary.style.display = 'flex';
                full.style.display = 'none';
                summary.style.opacity = 1 - (ratio * 2);
            } else {
                summary.style.display = 'none';
                full.style.display = 'block';
                full.style.opacity = (ratio - 0.5) * 2;
            }
        }

        function toggleTimeExpand() {
            if (sheetState === 'PEEK') updateSheetState('EXPANDED');
            else if (sheetState === 'EXPANDED') updateSheetState('PEEK');
        }

        function openClubDetail(id) {
            document.getElementById('topSearchInput').blur();
            var club = clubs.find(c => c.id === id);
            
            var titleHtml = club.name;
            if (club.insta) titleHtml += ' <a href="https://instagram.com/' + club.insta + '" target="_blank" class="insta-link">' + instaCssIcon + '</a>';
            document.getElementById('sheetTitle').innerHTML = titleHtml;
            document.getElementById('sheetPrice').innerText = club.price || "íšŒë¹„ ì •ë³´ ì—†ìŒ";
            document.getElementById('sheetAddressVal').value = club.address;
            
            renderTimetables(club.schedule);

            var tagHtml = '<span class="tag target">' + club.target + '</span>';
            if(club.link) tagHtml += '<a href="' + club.link + '" target="_blank" style="text-decoration:none"><span class="tag" style="background:#eee">ğŸ  í™ˆí˜ì´ì§€</span></a>';
            document.getElementById('sheetTags').innerHTML = tagHtml;
            document.getElementById('btnWay').href = "https://map.kakao.com/link/to/" + club.name + "," + club.lat + "," + club.lng;
            
            var urgentArea = document.getElementById('urgentArea');
            if (club.is_urgent && club.urgent_msg) {
                urgentArea.innerHTML = '<div class="urgent-banner">ğŸ”¥ ' + club.urgent_msg + '</div>';
                urgentArea.style.display = 'block';
            } else { urgentArea.style.display = 'none'; }

            // [NEW] ì°œí•˜ê¸° ë²„íŠ¼ì— onclick ì´ë²¤íŠ¸ ì—°ê²°
            var btnBookmark = document.getElementById('btnBookmark');
            btnBookmark.onclick = function() { bookmarkTeam(club.id); };
            
            updateSheetState('PEEK');
            
            var targetLevel = 4;
            map.setLevel(targetLevel, {animate: true});
            var moveLatLon = new kakao.maps.LatLng(club.lat, club.lng);
            var projection = map.getProjection();
            var centerPoint = projection.pointFromCoords(moveLatLon);
            var offsetY = Math.min(window.innerHeight * 0.13, 150); 
            var newCenterPoint = new kakao.maps.Point(centerPoint.x, centerPoint.y + offsetY);
            var newCenterLatLon = projection.coordsFromPoint(newCenterPoint);
            map.panTo(newCenterLatLon);
        }

        function closeBottomSheet() { updateSheetState('CLOSED'); }
        document.getElementById('btnCopy').onclick = function() { copyAddress(document.getElementById('sheetAddressVal').value); };
        function copyAddress(addr) {
            if (navigator.clipboard && navigator.clipboard.writeText) { navigator.clipboard.writeText(addr).then(() => { alert('ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“‹'); }); } 
            else { var t = document.createElement("input"); t.value = addr; document.body.appendChild(t); t.select(); document.execCommand("copy"); document.body.removeChild(t); alert('ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“‹'); }
        }

        // ê¸´ê¸‰ êµ¬ì¸ í‹°ì»¤ ë¡œì§
        var urgentClubs = clubs.filter(c => c.is_urgent && c.urgent_msg);
        var uniqueTickerList = [];
        var processedTeams = {};
        
        urgentClubs.forEach(function(c) {
            if (!processedTeams[c.name]) {
                uniqueTickerList.push(c);
                processedTeams[c.name] = true;
            }
        });

        if (uniqueTickerList.length > 0) {
            var tickerContainer = document.getElementById('urgentTicker');
            var tickerList = document.getElementById('tickerList');
            tickerContainer.style.display = 'flex';
            
            uniqueTickerList.forEach(function(c) {
                var li = document.createElement('li');
                li.className = 'ticker-item';
                li.innerHTML = '<b>[' + c.name + ']</b> ' + c.urgent_msg;
                li.onclick = function() { openClubDetail(c.id); };
                tickerList.appendChild(li);
            });

            if (uniqueTickerList.length > 1) {
                var tickerHeight = 44;
                var currentIndex = 0;
                setInterval(function() {
                    currentIndex++;
                    tickerList.style.top = '-' + (currentIndex * tickerHeight) + 'px';
                    
                    if (currentIndex === uniqueTickerList.length) {
                        setTimeout(function() {
                            tickerList.style.transition = 'none';
                            tickerList.style.top = '0px';
                            currentIndex = 0;
                            setTimeout(function() { tickerList.style.transition = 'top 0.5s ease-in-out'; }, 50);
                        }, 500); 
                    } else {
                        if (currentIndex === uniqueTickerList.length) currentIndex = 0;
                    }
                }, 3000);
                
                var firstClone = tickerList.children[0].cloneNode(true);
                firstClone.onclick = function() { openClubDetail(uniqueTickerList[0].id); };
                tickerList.appendChild(firstClone);
            }
        }

        const sheet = document.getElementById('bottomSheet');
        const handleArea = document.getElementById('sheetHandle');
        let startY = 0; let currentY = 0; let isDragging = false;
        let startHeight = 0;

        function bHandleStart(e) { 
            startY = e.touches ? e.touches[0].clientY : e.clientY; 
            isDragging = true; 
            sheet.style.transition = 'none'; 
            document.getElementById('timeMorphContainer').style.transition = 'none';
            startHeight = sheet.offsetHeight;
        }
        
        function bHandleMove(e) { 
            if (!isDragging) return; 
            if(e.cancelable && e.type.startsWith('touch')) e.preventDefault(); 
            currentY = e.touches ? e.touches[0].clientY : e.clientY; 
            const deltaY = currentY - startY; 
            
            let newHeight = startHeight - deltaY;
            if (newHeight > EXPANDED_HEIGHT) newHeight = EXPANDED_HEIGHT;
            sheet.style.height = newHeight + 'px';
            let ratio = (newHeight - PEEK_HEIGHT) / (EXPANDED_HEIGHT - PEEK_HEIGHT);
            interpolateMorph(ratio);
        }
        
        function bHandleEnd(e) { 
            if (!isDragging) return; isDragging = false; 
            sheet.style.transition = 'height 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)';
            document.getElementById('timeMorphContainer').style.transition = 'height 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)';
            let currentH = sheet.offsetHeight;
            if (currentH > (PEEK_HEIGHT + EXPANDED_HEIGHT) / 2) { updateSheetState('EXPANDED'); } 
            else { if (currentH < PEEK_HEIGHT * 0.8) updateSheetState('CLOSED'); else updateSheetState('PEEK'); }
            currentY = 0; startY = 0; 
        }
        
        handleArea.addEventListener('touchstart', bHandleStart, {passive: true}); handleArea.addEventListener('touchmove', bHandleMove, {passive: false}); handleArea.addEventListener('touchend', bHandleEnd); handleArea.addEventListener('mousedown', bHandleStart); window.addEventListener('mousemove', bHandleMove); window.addEventListener('mouseup', bHandleEnd);

        const filterSheet = document.getElementById('filterSheet');
        const filterHandle = document.getElementById('filterHandle');
        let fStartY = 0; let fCurrentY = 0; let fIsDragging = false;
        function fHandleStart(e) { fStartY = e.touches ? e.touches[0].clientY : e.clientY; fIsDragging = true; filterSheet.style.transition = 'none'; }
        
        function fHandleMove(e) { 
            if (!fIsDragging) return; 
            if(e.cancelable && e.type.startsWith('touch')) e.preventDefault(); 
            fCurrentY = e.touches ? e.touches[0].clientY : e.clientY; 
            const deltaY = fCurrentY - fStartY; 
            // ë°±í‹±(`) ë¬¸ë²• ìˆ˜ì • ì™„ë£Œ
            if (deltaY < 0) { filterSheet.style.transform = `translateY(${deltaY}px)`; } 
        }
        
        function fHandleEnd(e) { if (!fIsDragging) return; fIsDragging = false; let endY = e.changedTouches ? e.changedTouches[0].clientY : fCurrentY; if (!e.touches && fCurrentY === 0) endY = fStartY; const deltaY = endY - fStartY; filterSheet.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)'; if (deltaY < -50) { closeFilterSheet(); } else { filterSheet.style.transform = "translateY(0)"; } fCurrentY = 0; fStartY = 0; }
        filterHandle.addEventListener('touchstart', fHandleStart, {passive: true}); filterHandle.addEventListener('touchmove', fHandleMove, {passive: false}); filterHandle.addEventListener('touchend', fHandleEnd); filterHandle.addEventListener('mousedown', fHandleStart); window.addEventListener('mousemove', fHandleMove); window.addEventListener('mouseup', fHandleEnd);

        function toggleFilterSheet() {
            var sheet = document.getElementById('filterSheet');
            if (sheet.style.transform === "translateY(0px)" || sheet.style.transform === "") { closeFilterSheet(); } else { openFilterSheet(); }
        }

        function moveToMyLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var lat = position.coords.latitude, lon = position.coords.longitude;
                    var locPosition = new kakao.maps.LatLng(lat, lon);
                    if (myMarker) myMarker.setMap(null);
                    myMarker = new kakao.maps.Marker({ map: map, position: locPosition, image: gpsImage });
                    map.panTo(locPosition);
                });
            } else { alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); }
        }

        var selectedFilters = { 'region': [], 'day': [], 'target': [] };
        function openFilterSheet() { document.getElementById('filterSheet').style.transform = "translateY(0)"; }
        function closeFilterSheet() { document.getElementById('filterSheet').style.transform = "translateY(-100%)"; }
        function toggleFilter(category, value, element) {
            var index = selectedFilters[category].indexOf(value);
            if (index === -1) { selectedFilters[category].push(value); element.classList.add('selected'); } 
            else { selectedFilters[category].splice(index, 1); element.classList.remove('selected'); }
        }
        function resetFilters() {
            selectedFilters = { 'region': [], 'day': [], 'target': [] };
            document.querySelectorAll('.chip').forEach(el => el.classList.remove('selected'));
            document.getElementById('topSearchInput').value = ""; 
            applyFilters();
        }

        function applyFilters() {
            if (window.event && window.event.type === 'click') closeFilterSheet();
            var keyword = document.getElementById('topSearchInput').value.trim();
            var filterCount = selectedFilters.region.length + selectedFilters.day.length + selectedFilters.target.length;
            if (filterCount > 0) { document.getElementById('filterBadge').classList.add('active'); } 
            else { document.getElementById('filterBadge').classList.remove('active'); }

            clusterer.clear(); 
            var visibleNormalMarkers = []; 
            var bounds = new kakao.maps.LatLngBounds();

            markers.forEach(function(item) {
                var club = item.club;
                var regionMatch = true;
                if (selectedFilters.region.length > 0) {
                    regionMatch = false;
                    for (var i = 0; i < selectedFilters.region.length; i++) {
                        var r = selectedFilters.region[i];
                        if (r === "ì¶©ì²­" && (club.address.startsWith("ì¶©ë‚¨") || club.address.startsWith("ì¶©ë¶") || club.address.startsWith("ëŒ€ì „") || club.address.startsWith("ì„¸ì¢…"))) regionMatch = true;
                        else if (r === "ì „ë¼" && (club.address.startsWith("ì „ë‚¨") || club.address.startsWith("ì „ë¶") || club.address.startsWith("ê´‘ì£¼"))) regionMatch = true;
                        else if (r === "ê²½ìƒ" && (club.address.startsWith("ê²½ë‚¨") || club.address.startsWith("ê²½ë¶") || club.address.startsWith("ëŒ€êµ¬") || club.address.startsWith("ë¶€ì‚°") || club.address.startsWith("ìš¸ì‚°"))) regionMatch = true;
                        else if (club.address.startsWith(r)) regionMatch = true;
                    }
                }
                var dayMatch = true;
                if (selectedFilters.day.length > 0) {
                    dayMatch = false;
                    var cleanSchedule = club.schedule.replace(/ìš”ì¼/g, "");
                    if (cleanSchedule.includes("ë§¤ì¼")) dayMatch = true;
                    else { for (var i = 0; i < selectedFilters.day.length; i++) { if (cleanSchedule.includes(selectedFilters.day[i])) dayMatch = true; } }
                }
                var targetMatch = true;
                if (selectedFilters.target.length > 0) {
                    targetMatch = false;
                    var hasSpecialFilter = selectedFilters.target.some(t => ["ì—¬ì„±ì „ìš©", "ë‚¨ì„±ì „ìš©", "ì„ ì¶œê°€ëŠ¥", "6ì¸ì œ"].includes(t));
                    for (var i = 0; i < selectedFilters.target.length; i++) { if (club.target.includes(selectedFilters.target[i])) targetMatch = true; }
                    if (!hasSpecialFilter && club.target.includes("ë¬´ê´€")) targetMatch = true;
                }
                var keywordMatch = true;
                if (keyword.length > 0) { if (!club.name.includes(keyword) && !club.address.includes(keyword)) { keywordMatch = false; } }

                if (regionMatch && dayMatch && targetMatch && keywordMatch) { 
                    item.isVisible = true; 
                    if (club.is_urgent) { item.marker.setMap(map); } 
                    else { visibleNormalMarkers.push(item.marker); }
                    bounds.extend(item.marker.getPosition());
                } else { 
                    item.isVisible = false; 
                    item.marker.setMap(null); 
                    item.overlay.setMap(null); 
                }
            });
            
            clusterer.addMarkers(visibleNormalMarkers);
            updateLabelVisibility();

            if (!bounds.isEmpty() && (keyword.length > 0 || filterCount > 0)) { map.setBounds(bounds); }
        }
        
        // [NEW] ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸° (ì•ˆì „í•œ ë°©ì‹)
        const lbOverlay = document.getElementById('lunchboxOverlay');
        lbOverlay.addEventListener('click', function(e) {
            // ë‚´ê°€ í´ë¦­í•œ ëŒ€ìƒì´ ì˜¤ë²„ë ˆì´ ë°°ê²½(ê²€ì€ ë¶€ë¶„)ì¼ ë•Œë§Œ ë‹«ê¸°
            if (e.target === lbOverlay) {
                window.closeLunchbox();
            }
        });

        // [NEW] ê³µìœ  ê¸°ëŠ¥ ë¡œì§ (ì•ˆì •ì„± ê°•í™” ë²„ì „)
        function showShareOptions() {
            // ë„¤ì„ì¹´ë“œ ì˜¤ë²„ë ˆì´ëŠ” ë‹«ì§€ ì•Šê³  ìœ ì§€ (ì‚¬ìš©ìê°€ ë³´ë©´ì„œ ì„ íƒí•˜ê²Œ)
            if (confirm("ğŸ“¸ ì €ì¥í•  ëª¨ì–‘ì„ ì„ íƒí•´ì£¼ì„¸ìš”!\n\n[í™•ì¸] = ğŸ± í”¼ë“œìš© (ë„¤ì„ì¹´ë“œ+ë„ì‹œë½+ì‹ë‹¨í‘œ)\n[ì·¨ì†Œ] = ğŸ“± ìŠ¤í† ë¦¬ìš© (ë„¤ì„ì¹´ë“œ+ë„ì‹œë½)")) {
                generateShareImage('feed');
            } else {
                generateShareImage('story');
            }
        }

        async function generateShareImage(mode) {
            
            // [1ë²ˆ ë¬¸ì œ í•´ê²° ë¡œì§ ì¶”ê°€] -----------------------------------------
            // ë„ì‹œë½ì„ í•œ ë²ˆë„ ì•ˆ ì—´ì—ˆì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ë°ì´í„°ë¥¼ ë™ê¸°í™”í•˜ê³  ê°•ì œë¡œ ë Œë”ë§í•©ë‹ˆë‹¤.
            if (!currentProfileData.tempSlots) {
                let saved = currentProfileData.bookmarks || [];
                let normalized = [null, null, null, null, null];
                if (saved.length > 0) {
                    for(let i=0; i<5; i++) {
                        if (i < saved.length) normalized[i] = saved[i];
                    }
                }
                currentProfileData.tempSlots = normalized;
            }
            // í™”ë©´ì— ë³´ì´ì§€ ì•Šì•„ë„ DOMì„ êµ¬ì„±í•˜ê¸° ìœ„í•´ ë Œë”ë§ í•¨ìˆ˜ í˜¸ì¶œ
            renderLunchboxGrid(); 
            // -----------------------------------------------------------------
            
            const stage = document.getElementById('captureStage');
            stage.innerHTML = ""; // ì´ˆê¸°í™”
            
            // 1. ìŠ¤í…Œì´ì§€ ì¤€ë¹„ (ë³´ì´ê²Œ ì„¤ì •í•´ì•¼ ìº¡ì²˜ë¨)
            stage.style.visibility = "visible"; 
            stage.className = (mode === 'feed') ? 'mode-feed' : 'mode-story';

            // 2. ìš”ì†Œ ë³µì œ (ë„¤ì„ì¹´ë“œ & ë„ì‹œë½)
            const cardClone = document.getElementById('myProfileCard').cloneNode(true);
            cardClone.className += " cap-card";
            cardClone.style.margin = "0";
            // ë¶ˆí•„ìš”í•œ ìš”ì†Œ ì œê±°
            const removeSelectors = ['#loginSection', '#pcRiceWatermark', '.pc-edit-btn', '.pc-footer'];
            removeSelectors.forEach(sel => {
                const el = cardClone.querySelector(sel);
                if(el) el.remove();
            });

            // ë„ì‹œë½í†µ ìƒˆë¡œ ê·¸ë¦¬ê¸° (ê¸°ì¡´êº¼ ë³µì œí•˜ë©´ ê¼¬ì¼ ìˆ˜ ìˆì–´ì„œ ìƒˆë¡œ ìƒì„±)
            const boxContainer = document.createElement('div');
            boxContainer.className = "lunchbox-wrapper cap-box";
            boxContainer.style.border = "4px solid #8d6e63";
            boxContainer.innerHTML = `<div class="lb-header" style="justify-content:center; margin-bottom:15px; font-size:20px;"><span>ğŸ± ë‚˜ì˜ ë„ì‹œë½</span></div>`;
            
            // í˜„ì¬ ë„ì‹œë½ ìƒíƒœë¥¼ ê·¸ëŒ€ë¡œ ê°€ì ¸ì˜¤ê¸°
            const gridClone = document.getElementById('lunchboxGrid').cloneNode(true);
            gridClone.style.gap = "8px"; 
            gridClone.querySelectorAll('.lb-del-btn').forEach(el => el.remove()); // ì‚­ì œë²„íŠ¼ ì œê±°
            boxContainer.appendChild(gridClone);

            // 3. ì›Œí„°ë§ˆí¬ ìƒì„± (ì´ë¯¸ì§€+í…ìŠ¤íŠ¸)
            const watermark = document.createElement('div');
            watermark.className = "watermark";
            // [ìˆ˜ì •] ë¡œê³  ì´ë¯¸ì§€ ê²½ë¡œ í™•ì¸ (íŒŒì¼ëª… ë„ì–´ì“°ê¸° ì£¼ì˜)
            watermark.innerHTML = `<img src="./nulloongzido logo_512px.png" alt="ë¡œê³ "><span>ëˆ„ë£½ì§€ë„</span>`;

            // 4. ëª¨ë“œë³„ ë°°ì¹˜
            if (mode === 'story') {
                stage.appendChild(cardClone);
                stage.appendChild(boxContainer);
                stage.appendChild(watermark);
            } else {
                // í”¼ë“œ ëª¨ë“œ (ì¢Œìš°)
                const leftCol = document.createElement('div');
                leftCol.className = 'feed-col-left';
                leftCol.appendChild(cardClone);
                leftCol.appendChild(boxContainer);

                const rightCol = document.createElement('div');
                rightCol.className = 'feed-col-right';
                
                const header = document.createElement('div');
                header.className = 'feed-header';
                header.innerText = "ğŸ“… ì£¼ê°„ ì‹ë‹¨í‘œ";
                rightCol.appendChild(header);

                // ì‹ë‹¨í‘œ ê°•ì œ ìƒì„±
                const dietBody = document.createElement('div');
                dietBody.style.flex = "1";
                dietBody.style.width = "100%";
                dietBody.style.position = "relative";
                dietBody.style.backgroundColor = "white"; // ë°°ê²½ìƒ‰ ëª…ì‹œ

                // *ì¤‘ìš”* ê¸°ì¡´ ì‹ë‹¨í‘œ ì»¨í…ì¸ ë¥¼ HTML ë¬¸ìì—´ë¡œ ë³µì‚¬
                // (display:none ìƒíƒœì—¬ë„ innerHTMLì€ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŒ)
                const originalDiet = document.getElementById('dietPlanBody');
                
                // ë§Œì•½ ì‹ë‹¨í‘œê°€ ë¹„ì–´ìˆë‹¤ë©´(í•œ ë²ˆë„ ì•ˆ ì—´ì—ˆìœ¼ë©´) ê°•ì œë¡œ ë°ì´í„°ë¥¼ ì±„ì›€
                if (!originalDiet.hasChildNodes() || originalDiet.innerHTML.trim() === "") {
                    renderCombinedSchedule(); // ë°ì´í„° ìƒì„±
                }
                
                dietBody.innerHTML = originalDiet.innerHTML;
                
                // ìŠ¤íƒ€ì¼ ë³´ì • (ìŠ¤í¬ë¡¤ë°” ì œê±°, ë†’ì´ ìë™)
                const wrapper = dietBody.querySelector('.diet-body-wrapper');
                if(wrapper) {
                    wrapper.style.overflow = "visible";
                    wrapper.style.height = "auto";
                }
                
                rightCol.appendChild(dietBody);

                stage.appendChild(leftCol);
                stage.appendChild(rightCol);
                stage.appendChild(watermark);
            }

            // 5. ìº¡ì²˜ ì‹¤í–‰
            // ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸° (ìº¡ì²˜ ì¤‘ í™”ë©´ ê¹”ë”í•˜ê²Œ)
            const overlays = document.querySelectorAll('.profile-overlay, .lunchbox-overlay');
            overlays.forEach(el => el.style.display = 'none');

            // í°íŠ¸ ë° ì´ë¯¸ì§€ ë¡œë”© ëŒ€ê¸° í›„ ìº¡ì²˜
            setTimeout(() => {
                html2canvas(stage, { 
                    scale: 2, // ê³ í•´ìƒë„
                    useCORS: true, // ì´ë¯¸ì§€ ë¡œë”© í—ˆìš©
                    backgroundColor: null, // íˆ¬ëª… ë°°ê²½ ì§€ì›
                    logging: false
                }).then(canvas => {
                    const imgData = canvas.toDataURL("image/png");
                    
                    // ë¯¸ë¦¬ë³´ê¸° ì°½ì— í‘œì‹œ
                    const previewBox = document.getElementById('previewImgBox');
                    previewBox.innerHTML = "";
                    const img = document.createElement('img');
                    img.src = imgData;
                    previewBox.appendChild(img);
                    
                    document.getElementById('previewOverlay').style.display = 'flex';
                    
                    // ë’·ì •ë¦¬
                    stage.style.visibility = "hidden";
                    stage.innerHTML = ""; // ë©”ëª¨ë¦¬ í•´ì œ
                }).catch(err => {
                    alert("í¬ì¥í•˜ëŠ” ì¤‘ì— ë¬¸ì œê°€ ìƒê²¼ì–´ìš” ğŸ¥²: " + err);
                    stage.style.visibility = "hidden";
                    document.getElementById('profileOverlay').style.display = 'flex';
                });
            }, 300); // 0.3ì´ˆ ëŒ€ê¸° (ì•ˆì •ì„±)
        }

        function downloadImage() {
            const img = document.querySelector('#previewImgBox img');
            if (img) {
                const link = document.createElement('a');
                const timestamp = new Date().getTime();
                link.download = `ëˆ„ë£½ì§€ë„_ì¸ì¦ìƒ·_${timestamp}.png`;
                link.href = img.src;
                link.click();
            }
        }

        function closePreview() {
            document.getElementById('previewOverlay').style.display = 'none';
            // ë¯¸ë¦¬ë³´ê¸° ë‹«ìœ¼ë©´ í”„ë¡œí•„ ì¹´ë“œ ë‹¤ì‹œ ë³´ì—¬ì£¼ê¸°
            document.getElementById('profileOverlay').style.display = 'flex';
        }

        applyFilters();
    </script>
</body>
</html>